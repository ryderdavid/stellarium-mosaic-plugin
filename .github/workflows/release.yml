name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="manual-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Read Stellarium version
        id: stellarium_version
        run: echo "stellarium_version=$(cat config/stellarium-version.txt)" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Stellarium Mosaic Plugin ${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## Stellarium with Mosaic Planning Plugin

            This release includes Stellarium with the integrated Mosaic Planning plugin.

            **Stellarium Base Version:** ${{ steps.stellarium_version.outputs.stellarium_version }}
            **Plugin Version:** ${{ steps.get_version.outputs.version }}

            ### Features
            - Mosaic planning capabilities integrated into Oculars plugin
            - Configurable NÃ—M panel layouts
            - Adjustable overlap percentage
            - Rotatable mosaic grids
            - Real-time visualization

            ### Downloads
            - **macOS:** DMG (Apple Silicon arm64)
            - **Windows:** ZIP archive (x64)

            ### Installation
            See README.md for installation instructions.

  build-macos-dmg:
    name: Build macOS DMG
    runs-on: macos-14
    needs: create-release
    permissions:
      contents: write
    steps:
      - name: Checkout plugin repository
        uses: actions/checkout@v4
        with:
          path: plugin

      - name: Read Stellarium version
        id: version
        run: echo "STELLARIUM_VERSION=$(cat plugin/config/stellarium-version.txt)" >> $GITHUB_OUTPUT

      - name: Checkout Stellarium
        uses: actions/checkout@v4
        with:
          repository: Stellarium/stellarium
          ref: ${{ steps.version.outputs.STELLARIUM_VERSION }}
          path: stellarium
          submodules: true

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: macos-arm64-qt6-${{ steps.version.outputs.STELLARIUM_VERSION }}
          max-size: 2G

      - name: Install dependencies
        run: |
          brew install qt@6 cmake gettext ccache create-dmg glm dylibbundler

      - name: Apply patches
        run: |
          cd stellarium
          bash ../plugin/scripts/apply-patches.sh .

      - name: Build and bundle application
        run: |
          cd stellarium
          export Qt6_DIR="$(brew --prefix qt@6)/lib/cmake/Qt6"
          export PATH="$(brew --prefix ccache)/bin:$PATH"

          # Configure with bundle enabled
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt@6)" \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

          # Build
          cmake --build build -j 4

          # Install to create app bundle
          cmake --install build

          # Verify bundle was created
          ls -la build/Stellarium.app/Contents/MacOS/

      - name: Bundle all dependencies with macdeployqt
        run: |
          cd stellarium/build

          # Run macdeployqt to bundle Qt frameworks
          echo "=== Running macdeployqt ==="
          macdeployqt Stellarium.app -verbose=2

          # Bundle additional dependencies (md4c) with dylibbundler
          echo "=== Bundling additional dependencies ==="
          dylibbundler -b \
            -x Stellarium.app/Contents/MacOS/stellarium \
            -d Stellarium.app/Contents/Frameworks/ \
            -p @executable_path/../Frameworks/

          # Fix all @rpath references in bundled libraries
          echo "=== Fixing all @rpath references in bundled libraries ==="
          FRAMEWORKS_DIR="Stellarium.app/Contents/Frameworks"
          FIXED_COUNT=0
          COPIED_COUNT=0

          # Iteratively find and copy missing libraries (may have transitive dependencies)
          MAX_ITERATIONS=5
          for iteration in $(seq 1 $MAX_ITERATIONS); do
            echo "=== Iteration $iteration: Scanning for missing libraries ==="
            MISSING_LIBS=""

            # Find all .dylib files and check their @rpath dependencies
            find "$FRAMEWORKS_DIR" -name "*.dylib" -type f | while read -r lib; do
              RPATH_DEPS=$(otool -L "$lib" | grep '@rpath/' | awk '{print $1}')

              if [ -n "$RPATH_DEPS" ]; then
                echo "$RPATH_DEPS" | while read -r dep; do
                  LIB_NAME=$(basename "$dep")

                  # If library not in Frameworks, add to missing list
                  if [ ! -f "$FRAMEWORKS_DIR/$LIB_NAME" ]; then
                    echo "$LIB_NAME" >> /tmp/missing_libs.txt
                  fi
                done
              fi
            done

            # Get unique list of missing libraries
            if [ -f /tmp/missing_libs.txt ]; then
              MISSING_LIBS=$(sort -u /tmp/missing_libs.txt)
              rm /tmp/missing_libs.txt
            fi

            if [ -z "$MISSING_LIBS" ]; then
              echo "No missing libraries found"
              break
            fi

            # Try to find and copy missing libraries from Homebrew
            echo "Missing libraries to copy:"
            echo "$MISSING_LIBS"

            while IFS= read -r lib_name; do
              # Search common Homebrew locations
              FOUND_PATH=""
              for search_path in /opt/homebrew/lib /opt/homebrew/opt/*/lib /usr/local/lib /usr/local/opt/*/lib; do
                if [ -f "$search_path/$lib_name" ]; then
                  FOUND_PATH="$search_path/$lib_name"
                  break
                fi
              done

              if [ -n "$FOUND_PATH" ]; then
                echo "  Copying: $FOUND_PATH -> $FRAMEWORKS_DIR/$lib_name"
                cp "$FOUND_PATH" "$FRAMEWORKS_DIR/"
                COPIED_COUNT=$((COPIED_COUNT + 1))
              else
                echo "  Warning: Could not find $lib_name in Homebrew paths"
              fi
            done <<< "$MISSING_LIBS"
          done

          echo "=== Copied $COPIED_COUNT missing libraries ==="

          # Now fix all @rpath references
          echo "=== Fixing @rpath references ==="
          find "$FRAMEWORKS_DIR" -name "*.dylib" -type f | while read -r lib; do
            RPATH_DEPS=$(otool -L "$lib" | grep '@rpath/' | awk '{print $1}')

            if [ -n "$RPATH_DEPS" ]; then
              echo "Checking $lib for @rpath dependencies..."

              echo "$RPATH_DEPS" | while read -r dep; do
                LIB_NAME=$(basename "$dep")

                if [ -f "$FRAMEWORKS_DIR/$LIB_NAME" ]; then
                  echo "  Fixing: $dep -> @executable_path/../Frameworks/$LIB_NAME"
                  install_name_tool -change "$dep" "@executable_path/../Frameworks/$LIB_NAME" "$lib"
                  FIXED_COUNT=$((FIXED_COUNT + 1))
                else
                  echo "  Warning: $LIB_NAME still not found after copying"
                fi
              done
            fi
          done

          echo "=== Fixed $FIXED_COUNT @rpath references ==="

          # Re-sign the entire app bundle after modifying libraries
          echo "=== Re-signing entire app bundle ==="
          codesign --force --deep --sign - Stellarium.app

          echo "=== Verifying app signature ==="
          codesign --verify --deep --verbose=2 Stellarium.app

          echo "=== Final verification ==="
          echo "Frameworks count:"
          ls -1 Stellarium.app/Contents/Frameworks/ | wc -l
          echo "Sample frameworks:"
          ls -1 Stellarium.app/Contents/Frameworks/ | head -10
          echo "=== Checking for md4c ==="
          ls -1 Stellarium.app/Contents/Frameworks/ | grep md4c || echo "md4c not found"
          echo "=== Binary dependencies ==="
          otool -L Stellarium.app/Contents/MacOS/stellarium | head -30

      - name: Create DMG
        run: |
          cd stellarium/build
          # Create DMG from the app bundle
          create-dmg \
            --volname "Stellarium Mosaic" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "Stellarium-Mosaic-${{ needs.create-release.outputs.version }}-arm64.dmg" \
            "Stellarium.app"

      - name: Upload DMG to Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: stellarium/build/Stellarium-Mosaic-${{ needs.create-release.outputs.version }}-arm64.dmg

  build-windows-installer:
    name: Build Windows Installer
    runs-on: windows-latest
    needs: create-release
    permissions:
      contents: write
    steps:
      - name: Checkout plugin repository
        uses: actions/checkout@v4
        with:
          path: plugin

      - name: Read Stellarium version
        id: version
        shell: bash
        run: echo "STELLARIUM_VERSION=$(cat plugin/config/stellarium-version.txt)" >> $GITHUB_OUTPUT

      - name: Checkout Stellarium
        uses: actions/checkout@v4
        with:
          repository: Stellarium/stellarium
          ref: ${{ steps.version.outputs.STELLARIUM_VERSION }}
          path: stellarium
          submodules: true

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: windows-qt6-${{ steps.version.outputs.STELLARIUM_VERSION }}
          max-size: 2G
          variant: sccache

      - name: Install Qt6
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.*'
          arch: win64_msvc2019_64
          modules: 'qtmultimedia qtpositioning qtserialport qt5compat qtcharts'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Inno Setup
        shell: powershell
        run: |
          choco install innosetup -y
          # Add Inno Setup to PATH for subsequent steps
          $InnoPath = "C:\Program Files (x86)\Inno Setup 6"
          echo "$InnoPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Apply patches
        shell: bash
        run: |
          cd stellarium
          bash ../plugin/scripts/apply-patches.sh .

      - name: Configure and Build
        shell: bash
        run: |
          cd stellarium
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=C:/stellarium-install \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
          cmake --build build -j 4

      - name: Install and Create Installer
        shell: bash
        run: |
          cd stellarium
          # Install to staging directory
          cmake --install build

          # Debug: Check if qtstuff directory exists
          echo "=== Checking install directory structure ==="
          ls -la C:/stellarium-install/ || true
          ls -la C:/stellarium-install/qtstuff/ || echo "qtstuff directory not found!"

          # Debug: Check windeployqt logs
          echo "=== windeployqt log ==="
          cat build/src/windeployqt.log || echo "No windeployqt log file"
          echo "=== windeployqt errors ==="
          cat build/src/windeployqt.err || echo "No windeployqt error file"

          # Build the Inno Setup installer
          cmake --build build --target stellarium-installer

      - name: Upload Installer to Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: stellarium/installers/stellarium-*.exe
