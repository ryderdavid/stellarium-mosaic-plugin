name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="manual-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Read Stellarium version
        id: stellarium_version
        run: echo "stellarium_version=$(cat config/stellarium-version.txt)" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Stellarium Mosaic Plugin ${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## Stellarium with Mosaic Planning Plugin

            This release includes Stellarium with the integrated Mosaic Planning plugin.

            **Stellarium Base Version:** ${{ steps.stellarium_version.outputs.stellarium_version }}
            **Plugin Version:** ${{ steps.get_version.outputs.version }}

            ### Features
            - Mosaic planning capabilities integrated into Oculars plugin
            - Configurable NÃ—M panel layouts
            - Adjustable overlap percentage
            - Rotatable mosaic grids
            - Real-time visualization

            ### Downloads
            - **macOS:** DMG (Apple Silicon arm64)
            - **Windows:** ZIP archive (x64)

            ### Installation
            See README.md for installation instructions.

  build-macos-dmg:
    name: Build macOS DMG
    runs-on: macos-14
    needs: create-release
    permissions:
      contents: write
    steps:
      - name: Checkout plugin repository
        uses: actions/checkout@v4
        with:
          path: plugin

      - name: Read Stellarium version
        id: version
        run: echo "STELLARIUM_VERSION=$(cat plugin/config/stellarium-version.txt)" >> $GITHUB_OUTPUT

      - name: Checkout Stellarium
        uses: actions/checkout@v4
        with:
          repository: Stellarium/stellarium
          ref: ${{ steps.version.outputs.STELLARIUM_VERSION }}
          path: stellarium
          submodules: true

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: macos-arm64-qt6-${{ steps.version.outputs.STELLARIUM_VERSION }}
          max-size: 2G

      - name: Install dependencies
        run: |
          brew install qt@6 cmake gettext ccache create-dmg glm

      - name: Apply patches
        run: |
          cd stellarium
          bash ../plugin/scripts/apply-patches.sh .

      - name: Configure and Build
        run: |
          cd stellarium
          export Qt6_DIR="$(brew --prefix qt@6)/lib/cmake/Qt6"
          export PATH="$(brew --prefix ccache)/bin:$PATH"
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt@6)" \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          cmake --build build -j 4
          cmake --install build

      - name: Bundle third-party libraries
        run: |
          cd stellarium/build

          # Check what libraries the executable depends on
          echo "=== Current library dependencies ==="
          otool -L Stellarium.app/Contents/MacOS/stellarium | grep -v "Stellarium.app"

          # Create Frameworks directory if it doesn't exist
          mkdir -p Stellarium.app/Contents/Frameworks

          # Find and copy md4c library
          MD4C_PREFIX=$(brew --prefix md4c)
          MD4C_LIB="$MD4C_PREFIX/lib/libmd4c-html.0.dylib"

          if [ ! -f "$MD4C_LIB" ]; then
            echo "ERROR: md4c library not found at $MD4C_LIB"
            exit 1
          fi

          cp "$MD4C_LIB" Stellarium.app/Contents/Frameworks/

          # Get the actual library path from otool
          OLD_PATH=$(otool -L Stellarium.app/Contents/MacOS/stellarium | grep libmd4c-html | awk '{print $1}')
          echo "Old md4c path: $OLD_PATH"

          # Fix the library path in the main executable
          install_name_tool -change \
            "$OLD_PATH" \
            "@executable_path/../Frameworks/libmd4c-html.0.dylib" \
            Stellarium.app/Contents/MacOS/stellarium

          # Fix the library's own install name
          install_name_tool -id \
            "@executable_path/../Frameworks/libmd4c-html.0.dylib" \
            Stellarium.app/Contents/Frameworks/libmd4c-html.0.dylib

          echo "=== After fixing ==="
          echo "Frameworks contents:"
          ls -la Stellarium.app/Contents/Frameworks/ | grep md4c
          echo "Updated dependencies:"
          otool -L Stellarium.app/Contents/MacOS/stellarium | grep md4c

      - name: Create DMG
        run: |
          cd stellarium/build
          # The app bundle is created at build/Stellarium.app by cmake install
          # macdeployqt was already run during install, now create the DMG
          create-dmg \
            --volname "Stellarium Mosaic" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "Stellarium-Mosaic-${{ needs.create-release.outputs.version }}-arm64.dmg" \
            "Stellarium.app"

      - name: Upload DMG to Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: stellarium/build/Stellarium-Mosaic-${{ needs.create-release.outputs.version }}-arm64.dmg

  build-windows-zip:
    name: Build Windows ZIP
    runs-on: windows-latest
    needs: create-release
    permissions:
      contents: write
    steps:
      - name: Checkout plugin repository
        uses: actions/checkout@v4
        with:
          path: plugin

      - name: Read Stellarium version
        id: version
        shell: bash
        run: echo "STELLARIUM_VERSION=$(cat plugin/config/stellarium-version.txt)" >> $GITHUB_OUTPUT

      - name: Checkout Stellarium
        uses: actions/checkout@v4
        with:
          repository: Stellarium/stellarium
          ref: ${{ steps.version.outputs.STELLARIUM_VERSION }}
          path: stellarium
          submodules: true

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: windows-qt6-${{ steps.version.outputs.STELLARIUM_VERSION }}
          max-size: 2G
          variant: sccache

      - name: Install Qt6
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.*'
          arch: win64_msvc2019_64
          modules: 'qtmultimedia qtpositioning qtserialport qt5compat qtcharts'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Apply patches
        shell: bash
        run: |
          cd stellarium
          bash ../plugin/scripts/apply-patches.sh .

      - name: Configure and Build
        shell: bash
        run: |
          cd stellarium
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
          cmake --build build -j 4

      - name: Package
        shell: bash
        run: |
          cd stellarium/build
          # List directory to debug
          echo "=== Build directory contents ==="
          ls -la
          echo "=== src directory contents ==="
          ls -la src/ || echo "No src/ directory"
          # Create package directory
          mkdir -p package
          # With Ninja, exe is in src/ not src/Release/
          cp stellarium.exe package/ || cp src/stellarium.exe package/ || echo "Could not find stellarium.exe"
          # Copy Qt dependencies
          windeployqt package/stellarium.exe
          # Create zip
          7z a "Stellarium-Mosaic-${{ needs.create-release.outputs.version }}-win64.zip" package/*

      - name: Upload ZIP to Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: stellarium/build/Stellarium-Mosaic-${{ needs.create-release.outputs.version }}-win64.zip
